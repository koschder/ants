\section{Missionen}
\label{sec:module.Missionen}

Missionen sind das Herzstück unseres \gls{Bot}s. Eine Mission dauert meist über mehrere Spielzüge und berechnet für jede teilnehmende Ameise ihre nächste Bewegung. Abbildung \ref{fig:missions} zeigt, dass alle Missionen von der abstrakten BaseMission abstammen und die BaseMission das Interface Mission implementiert. Die Lebensdauer einer Mission hängt davon ab, ob sie ihr Ziel erreicht oder ob sie schon früher abgebrochen wird. Ziel und Abbruchbedingungen sind je nach Mission unterschiedlich und werden im jeweiligen Abschnitt erklärt.

\begin{figure}[H]
\centering
\includegraphics[width=0.9\textwidth]{91_bilder/Missions}
\caption{Missionen und ihre Hierarchie}
\label{fig:missions}
\end{figure}


\subsection{BaseMission}
\label{subsec:module.Mission.BaseMission}

Diese Klasse erfüllt zwei Aufgaben: Erstens stellt sie Standard-Implementierungen der vom Interface Mission vorgegebenen Methoden zur Verfügung, und zweitens implementiert sie gemeinsame Funktionen, die von den spezifischen Missionen verwendet werden. Die wichtigsten Funktionalitäten sind hier mit Erklärung aufgelistet.

\begin{itemize}
	\item  \textbf{abandonMission():} Abbrechen der Mission
	\item  \textbf{addAnt():} Ameise der Mission hinzufügen, in der Population als beschäftigt markieren.
	\item  \textbf{doAnyMove(Ant a):} Für die mitgegebene Ameise irgendein Zug in eine der vier Richtung bestimmen.
	\item  \textbf{doMoveInDirection(Ant ant, Tile target):} Einen Zug in eine bestimmte Richtung bestimmen.
	\item  \textbf{gatherAnts(...):} Ameisen für die Mission rekrutieren. Die Anzahl Ameisen wird als Parameter mitgegeben. 
	\item  \textbf{moveToNextTileOnPath(Ant a):} Bewegt die Ameise ein Tile weiter auf dem ihr zugewiesenen Pfad.
	\item  \textbf{putMissionOrder(...):} Wurde ein Befehl für die Ameise gefunden, wird er der Klasse Orders (Verwaltung der Befehle) mitgeteilt.
	\item  \textbf{releaseAnts(int amount):} Ameisen von der Mission entlassen. 
	\item  \textbf{checkEnviroment(...):} Mittels Breitensuche wird die Umgebung der Ameise nach eigenen und gegnerischen Hügeln, gegnerischen Ameisen und Futterzellen gescannt. Je nach Mission wird beim Fund eines solchen Objekts die Mission abgebrochen, oder die Ameise von der Mission entlassen.
\end{itemize}

Nachfolgend werden die spezifischen Missionen erläutert. Tabellarisch werden die Eigenschaften der Missionen aufgelistet, danach folgen detaillierte Informationen zur Mission.


\subsection{PathMission}
\label{subsec:module.Mission.PathMission}

\begin{table}[H]
	%weird hack to enable footnotes in the table
	\begin{minipage}{11cm}
		\begin{tabular}{l p{13cm}}
		\textbf{Precondition}\footnote{Vorbedingung}& Der Pfad wurde vorgängig berechnet\\
		\textbf{Creator}\footnote{Ersteller der Mission}& CombatTask, oder ExploreMission\\
		\textbf{Postcondition}\footnote{Nachbedingung}& Der Pfad ist vollständig abgelaufen\\
		\textbf{Max. Ants}\footnote{Maximale Anzahl der Ameisen in der Mission}& 1\\
		\textbf{Max. Missionen}\footnote{Anzahl Missionen, die erstellt werden}& unbegrenzt\\
		\textbf{Valid}\footnote{Gültigkeit}& siehe ExploreMission bzw. CombatTask\\
		\textbf{Gather Ants}\footnote{Ameisen für die Mission rekrutieren}& Nicht möglich\\
		\textbf{Release Ants}\footnote{Ameisen von der Mission entlassen}& Nicht möglich\\
		\end{tabular}\par
		\vspace{-0.75\skip\footins}
   \renewcommand{\footnoterule}{}
  \end{minipage}
	\caption{Eigenschaften der PathMission}
	\label{tab:porpertiesPathMission}
\end{table}

Die Pathmission ist eine abstrakte Klasse die von ExploreMission und als anonyme Klasse im CombatTask implementiert wird. Die einzige Funktionalität die angeboten wird ist, eine Ameise, die dem Konstruktor mit Pfad mitgegeben wird, auf diesem definierten Pfad zu bewegen.

\subsection{AttackHillMission}
\label{subsec:module.Mission.AttackHillMission}

\begin{table}[H]
	%weird hack to enable footnotes in the table
	\begin{minipage}{11cm}
		\begin{tabular}{l p{13cm}}
		\textbf{Precondition}& Gegnerischer Hügel ist sichtbar\\
		\textbf{Creator}& AttackHillsTask\\
		\textbf{Postcondition}& Gegnerischer Hügel wurde erobert\\
		\textbf{Max. Ants}& unbegrenzt\\
		\textbf{Max. Missionen}& Je gegnerischen Hügel eine Mission\\
		\textbf{Valid}& Solange der gegnerischer Hügel nicht zerstört ist.\\
		\textbf{Gather Ants}& pro Zug max. fünf Ameisen, die im Umkreis von 25 Tiles des gegnerischen Hügel sind.\\
		\textbf{Release Ants}&  Sicheres Food-Tile in der Nähe, eigener Hügel in der Nähe, der Unterstützung bei der Verteidigung braucht. Wenn die Mission im Status ControlHill ist, dann werden alle Ameisen ausser zwei entlassen; diese kontrollieren den gegnerischen Hügel.\\
		\end{tabular}\par
		\vspace{-0.75\skip\footins}
   \renewcommand{\footnoterule}{}
  \end{minipage}
	\caption{Eigenschaften der AttackHillMission}
	\label{tab:porpertiesAttackHillMission}
\end{table}

Diese Mission unterscheidet zwischen den drei verschiedenen Modi \texttt{ControlEnemyHill}, \texttt{DestroyHill} und \texttt{AttackEnemyHill}. Der Modus wird zu Beginn jeder Runde durch die Methode \texttt{determineState()} definiert.


\paragraph{AttackEnemyHill:}
Dieser Modus  ist der Default-Modus, und ist aktiv wenn die beiden anderen Modi nicht zutreffen.
Alle Angreifer werden anhand ihrer Position in lokalen Gruppen zusammen gefasst. Für jede Gruppe wird ein Pfad zum gegnerischen Hügel berechnet. Falls der Pfad länger ist als fünf Tiles wird ein Meilenstein (Milestone) definiert. Nun werden mittels Breitensuche die Gegner zwischen dem Meilenstein und der Gruppe ermittelt. Mit dieser Ausgangslage wird eine AttackingCombatPositioning-Klasse initialisiert. Als Parameter werden die Gruppe, die gegnerischen Ameisen sowie der Meilenstein mitgegeben. Die Klasse berechnet die nächsten Bewegungen der Gruppe. (Details zur Berechnung siehe \ref{sec:module.CombatSituation})
       
\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/AttackHill}
\caption[Angriff auf einen gegnerischen Hügel]{Die Zweiergruppe ist in Kampfstellung. Vier weitere Ameisen rücken zur Front auf.}
\label{fig:AttackHill}
\end{figure}

\paragraph{ControlEnemyHill:}
Dieser Modus ist aktiv, wenn zwei oder mehr eigene Ameisen in der Nähe des gegnerischen Hügel sind, der Gegner aber nur eine Ameise zur Verteidigung hat.

In diesem Moduls braucht die Mission nur zwei Ameisen, jene die am nächsten beim gegnerischen Hügel sind, die anderen werden entlassen. Die übrigen zwei Ameisen positionieren sich, vom gegnerischen Hügel aus, auf einer der vier diagonal gelegenen Zellen. Dank dieser Positionierung werden alle gegnerischen Ameisen, die neu aus dem Hügel schlüpfen, sofort vernichtet. Der Gegner kann sich so nur durch Ameisen vermehren, die aus einem anderen Hügel schlüpfen. (Die Ameisen schlüpfen zufällig aus einem Hügel.) Der Hügel wird erst zerstört wenn das Spiel endet, oder sich der Gegner mit anderen Ameisen dem Hügel nähert.

\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/ControlEnemyHill}
\caption[Kontrolle eines gegnerischen Hügels]{Ein gegnerischer Hügel wird durch unsere Ameisen (orange) kontrolliert.}
\label{fig:ControlEnemyHill}
\end{figure}

\paragraph{DestroyHill:}
Dieser Modus ist aktiv, wenn das Spiel fünf Züge vor Spielende ist.
Wenn dieser Modus eintrifft ist, das Spiel fast zu Ende. Deshalb wird versucht, um jeden Preis den Hügel zu erobern, indem die Ameisen auf dem kürzesten Weg und ohne Positionierung in Richtung des Hügels geschickt werden.

\subsection{DefendHillMission}
\label{subsec:module.Mission.DefendHillMission}

\begin{table}[H]
	%weird hack to enable footnotes in the table
	\begin{minipage}{11cm}
		\begin{tabular}{l p{13cm}}
		\textbf{Precondition}& - \\
		\textbf{Creator}& DefendHillTask\\
		\textbf{Postcondition}& Eigener Hügel wurde zerstört\\
		\textbf{Max. Ants}& unbegrenzt\\
		\textbf{Max. Missionen}& Je eigener Hügel eine Mission\\
		\textbf{Valid}& Solange der eigener Hügel nicht erobert ist.\\
		\textbf{Gather Ants}& Die Mission soll immer mehr Verteidiger haben als Angreifer sich dem Hügel nähern.\\
		\textbf{Release Ants}& Sind keine Angreifer in Sicht, wird ein Teil der Ameisen (nicht alle) entlassen.\\
		\end{tabular}\par
		\vspace{-0.75\skip\footins}
   \renewcommand{\footnoterule}{}
  \end{minipage}
	\caption{Eigenschaften der DefendHillMission}
	\label{tab:porpertiesDefendHillMission}
\end{table}

Beim Entwickeln dieser Mission haben wir uns folgende Fragen gestellt: Ab welchem Spielzug soll der Hügel bewacht werden? Wie viel Ameisen sollen für die Verteidigung eingesetzt werden? Was, wenn der Hügel von mehreren Seiten angegriffen wird? Sollen alle Hügel bewacht werden? Aus diesen Frage ergab sich folgende Implementation.

Die DefendHillMission bietet zwei Arten zur Verteidigung an. Die Default-Verteidigung und die Barrier-Verteidigung. Bei der Default-Verteidigung werden die Ameise nahe um den eigenen Hügel zur Verteidigung aufgestellt. Die Barrier-Verteidigung ist nur bei Hügeln möglich, die in einer Sackgasse sind, denn in diesem Modus wird eine Sperre an der engsten Stelle erstellt. Nachfolgende Abbildung veranschaulicht die beiden Verteidigungsarten.

\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/DefendHillModi}
\caption[Verschiedene Modi der Verteidigung]{Links die Default-Verteidigung, rechts mit einer Barrier (Sperre).}
\label{fig:DefendHillModi}
\end{figure}

Die Art der Verteidigung wird wie folgt definiert. Während dem zehnten Spielzug\footnote{Im zehnten Spielzug müssen im Allgemeinen nur wenige andere Berechnungen durchgeführt werden, deshalb haben wir diesen Zug für die Barrier-Suche gewählt.} wird versucht, mittels spezieller Breitensuche eine Sperre für den Hügel zu finden. Falls dies gelingt, wird die Sperre erstellt, der Verteidiungsmodus ist Barrier. Dies solange, bis eine gegnerische Ameise auf die Höhe der Barriere tritt, dann gehen wir davon aus, dass die Sperre vom Gegner eingenommen wurde und wechseln die Verteidigungsart.

\lstset{language=Java, tabsize=4}
\begin{lstlisting}[caption=Die Verteidigungsart wird bestimmt.]
private void determineMode() {
  if (Ants.getAnts().getTurn() == 10) {
      AntsBreadthFirstSearch bfs = new AntsBreadthFirstSearch(Ants.getWorld());
      barrier = bfs.getBarrier(hill, Ants.getWorld().getViewRadius2(), 5);
      if (barrier != null) {
          mode = DefendMode.Barrier;
      }
  } else if (Ants.getAnts().getTurn() > 10 && mode == DefendMode.Barrier) {
	/* if we switched to barrier defend-mode we have to check if we aren't overrun. (enemy ant on barrier) if we are overrun, we switch back to the default mode. */
      for (Tile t : barrier.getBarrier()) {
          if (Ants.getWorld().getIlk(t) == Ilk.ENEMY_ANT) {
              mode = DefendMode.Default;
              break;
          }
    }
}
\end{lstlisting}

\subsubsection{Default-Modus}
\label{subsubsec:module.Mission.DefendHillMission.DefaultModus}

Hier wird lediglich berechnet, wie viele Ameisen den Hügel angreifen. Die Angreifer und die Verteidiger werden dem DefendingCombatPositioning übergeben, dieses berechnet dann die Züge für die Ameisen. Es ist einstellbar, ab welchem Zug die DefendHillMission auch dann Ameisen für die Verteidigung rekrutiert, wenn gar keine Angreifer in Sichtweite sind. Zudem kann mit dem Parameter \texttt{DEFENDER\_MORETHAN\_ATTACKERS} definiert werden, wie viele Ameisen mehr als die Anzahl Angreifer  zur Verteidigung rekrutiert werden. Ameisen werden von der Mission entlassen, wenn weniger Angreifer als Verteidiger, unter der Berücksichtigung des genannten Parameters, gezählt werden.

\subsubsection{Barrier-Modus}
\label{subsubsec:module.Mission.DefendHillMission.BarrierModus}

Wie schon erwähnt, kann dieser Modus nur eintreffen, wenn die Geländegegebenheiten stimmen. Ziel ist es, Engpässe auszunutzen um mit möglichst wenigen Ameisen zu verteidigen. Eine weitere Idee der Verwendung einer Sperre ist, dass durch die Sperre der Gegner die Umgebung dahinter nicht erkunden kann. So bekommt er unseren Hügel nie zu Gesicht und wird dadurch eventuell auch keinen Angriff starten. Diese Art zu verteidigen hat den Nachteil, dass die Ameisen welche für die Sperre benötigt werden, entsprechend statisch platziert werden. Diese können dann nicht für andere Aufgaben verwendet werden.

Die Sperre wurde gegen Xathis\footnote{Der Sieger-Bot des Wettbewerbs} getestet und sie zeigte nur eine geringe Wirkung. Der Bot von Xathis wartet vor der Sperre bis er in Überzahl ist und überrumpeln dann unsere Verteidigung. Erstaunlicherweise wird die Sperre von Greentea\footnote{zweitbester Bot}, auch wenn er in Überzahl ist, nicht angegriffen. Gegen diesen Gegner war die Sperre also gutes Mittel zur Verteidigung.

Die Funktionsweise ist wie folgt: Es werden je nach Breite der Sperre entsprechend viele Ameisen zur Position der Sperre geschickt um diese aufzubauen. Die Ameisen stellen sich paarweise hintereinander auf, solange keine Gegner in der Nähe sind. So können eigene Ameisen, die einer anderen Aufgabe nachgehen, die Sperre passieren. Wenn der Gegner sich in Überzahl nähert, wird die Sperre geschlossen. Danach wird das Kampfverhalten dem AttackingCombatPositioning überlassen, welches die Positionierung übernimmt.

\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/barrierCloseExample}
\caption[Eine geschlossene Sperre zur Verteidigung]{Die Sperre wird aufgebaut und geschlossen, aber trotz gegnerischer Überzahl nicht angegriffen. (Gegner: Greentea)}
\label{fig:CloseBarrier}
\end{figure}

\subsection{ExploreMission}
\label{subsec:module.Mission.ExploreMission}

\begin{table}[H]
	%weird hack to enable footnotes in the table
	\begin{minipage}{11cm}
		\begin{tabular}{l p{13cm}}
		\textbf{Precondition}& - \\
		\textbf{Creator}& ExploreTask\\
		\textbf{Postcondition}& Definierter Erkundungspfad wurde zurückgelegt\\
		\textbf{Max. Ants}& 1\\
		\textbf{Max. Missionen}& unbegrenzt\\
		\textbf{Valid}& Wird oft abgebrochen, wenn interessante Objekte in der Umgebung entdeckt werden, siehe Beschreibung\\
		\textbf{Gather Ants}& nicht möglich \\
		\textbf{Release Ants}& nicht möglich \\
		\end{tabular}\par
		\vspace{-0.75\skip\footins}
   \renewcommand{\footnoterule}{}
  \end{minipage}
	\caption{Eigenschaften der ExploreMission}
	\label{tab:porpertiesExploreMission}
\end{table}

Die ExploreMission wird verwendet, um die Spielkarte zu erkunden. Die Ameise läuft den vom ExploreTask vorgegebenen Pfad ab. Falls dieser ungültig ist, weil er zum Beispiel durch Wasser führt oder die Ameise sich nicht bewegen kann, da die Ameise durch eine andere Ameise blockiert wird, so wird die Mission abgebrochen. Die Mission wird auch abgebrochen, wenn Futter in der Nähe ist, wenn ein gegnerischer Hügel oder gegnerische Ameisen auftauchen, oder wenn ein eigener Hügel in der Nähe Hilfe braucht.

\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/exploreMission}
\caption[Erkundungsmission]{Eine Ameise auf einer ExploreMission bewegt sich in Richtung \gls{FogofWar}}
\label{fig:exploreMission}
\end{figure}

\subsection{GatherFoodMission}
\label{subsec:module.Mission.GatherFoodMission}

\begin{table}[H]
	%weird hack to enable footnotes in the table
	\begin{minipage}{11cm}
		\begin{tabular}{l p{13cm}}
		\textbf{Precondition}& - \\
		\textbf{Creator}& GatherFoodTask\\
		\textbf{Postcondition}& Diese Mission besteht während dem ganzen Spiel.\\
		\textbf{Max. Ants}& unbegrenzt\\
		\textbf{Max. Missionen}& 1\\
		\textbf{Valid}& immer\\
		\textbf{Gather Ants}& siehe Beschreibung \\
		\textbf{Release Ants}& siehe Beschreibung \\
		\end{tabular}\par
		\vspace{-0.75\skip\footins}
   \renewcommand{\footnoterule}{}
  \end{minipage}
	\caption{Eigenschaften der GatherFoodMission}
	\label{tab:porpertiesGatherFoodMission}
\end{table}

Diese Mission koordiniert die Futtersuche und verwaltet die Ameisen, welche Futter einsammeln. Es wird nur eine GatherFoodMission zu Beginn des Spiels erstellt. Sie berechnet, welche Ameise am nächsten bei einer Futterzelle ist, berechnet den Pfad und schickt die Ameise Zug um Zug in Richtung Futter. Die \texttt{execute()}-Methode der GatherFoodMission sieht wie folgt aus:

\lstset{language=Java, tabsize=4}
\begin{lstlisting}[caption=execute() Methode der GatherFoodMission]
@Override
public void execute() {
	// check the existing routes, if they are still valid.
	checkAntsRoutes();
	// gather new ants, relcalculate routes
	gatherAnts();
	// move the ants
	moveAnts();
}
\end{lstlisting}

Bei \texttt{checkAntsRoutes()} wird geprüft, ob die Pfade aller Ameisen in der Mission noch gültig sind. Ungültige Pfade sind, wenn die Futterzelle von der eigenen Ameise oder einer gegnerischen Ameise gefressen wurde. Ameisen mit einem ungültigen Pfad werden von der Mission entlassen, können aber in der nächsten Methode \texttt{gatherAnts()}, falls eine geeignete Aufgabe für die Ameise gefunden wird, der Mission wieder beitreten. Die Logik der \texttt{gatherAnts()} Methode ist in Listing \ref{lst:gatherAnts} vereinfacht dargestellt.

\lstset{language=Java, tabsize=4}
\begin{lstlisting}[caption=Berechnung welche Ameise welches Futter einsammelt., label=lst:gatherAnts]
foreach(food on map){
	if(there is an ant gathering this food tile with a path smaller than 5)
		continue;
	Ant ant = getNearestAntWithBreadthFirstSearch();
	if(ant found)
		possibleRoutes.add(new Route(ant,food));
}
foreach(Route r in possibleRoutes){
	Path path = getPathWithAStar(r);
	if(foodIsTargetedbyOtherAnt()){
			compareDistances()
			if(new path is shorter){
					newGatherFoodRoute(r.ant,r.food,path);
					releaseAnt(otherAnt);
			}
			continue;
	}
	if(hasAlreadyGatherFoodRoute(r.ant)
			takeSmallerRoute();
	else
			newGatherFoodRoute(r.ant,r.food,path);
}
\end{lstlisting}

Zum Schluss folgt die \texttt{moveAnts()}-Methode. Hier werden die Ameisen auf ihrem Pfad zur Futterzelle einen Zug weiter bewegt. Die Züge werden der Orders-Klasse (Befehlsverwaltung) übergeben.

\begin{figure}[H]
\centering
\includegraphics[height=40mm]{91_bilder/gatherfood}
\caption{Ameisen beim Futter sammeln.}
\label{fig:gatherfood}
\end{figure}

In der Abbildung \ref{fig:gatherfood} ist links zu sehen wie für beide Ameisen ein Futterpfad definiert ist, beide Ameisen folgen ihrem Pfad. Zwei Züge später (rechtes Bild) hat die Ameise links ihr Futter eingesammelt und steht für eine neue Aufgabe zur Verfügung. Der beschriebene Algorithmus merkt, dass die Ameise näher an der Futterzelle oben im Bild ist und löst die andere Ameise, welche bis dahin auf das Futter zu steuerte, von der Aufgabe ab. Die abgelöste Ameise wird von der GatherFoodMission entlassen und geht einer anderen Beschäftigung nach (hier: ExploreMission).

\subsection{Verworfene und nicht verwendete Mission}
\label{subsec:implementation.Tasks.StupidMission}

Wie bereits im Kapitel Task erwähnt, war nicht alles Programmierte erfolgreich. Hier sind die Missionen aufgelistet die zu den verworfen oder nicht verwendeten Tasks gehören. (Begründungen siehe Tasks)

\begin{itemize}
\item \textbf{SwarmPathMission}
\item \textbf{AttackHillsInFlockMission}
\item \textbf{ConcentrateMission}
\item \textbf{FlockMission}
\end{itemize}